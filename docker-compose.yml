version: '3.8'

networks:
  dev_mesh:
    driver: bridge

volumes:
  neo4j_data:
  neo4j_logs:

services:
  # --- Database ---
  neo4j:
    image: neo4j:community
    container_name: ${COMPOSE_PROJECT_NAME}_neo4j
    ports:
      - "${NEO4J_HTTP_PORT}:7474"
      - "${NEO4J_BOLT_PORT}:7687"
    environment:
      NEO4J_AUTH: neo4j/password
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
    networks:
      - dev_mesh

  # --- Application Backend ---
  dev_backend:
    build:
      context: ./backend
    container_name: ${COMPOSE_PROJECT_NAME}_dev_backend
    working_dir: /app
    command: uvicorn main:app --host 0.0.0.0 --port 8000 --reload
    ports:
      - "${BACKEND_PORT}:8000"
    volumes:
      - ./backend:/app
    environment:
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=password
    networks:
      - dev_mesh
    depends_on:
      - neo4j

  # --- Application Frontend ---
  dev_frontend:
    build:
      context: ./frontend
    container_name: ${COMPOSE_PROJECT_NAME}_dev_frontend
    working_dir: /app
    command: npm run dev
    ports:
      - "${FRONTEND_PORT}:5173"
    volumes:
      - ./frontend:/app
      - /app/node_modules
    environment:
      - CHOKIDAR_USEPOLLING=true
    networks:
      - dev_mesh
    depends_on:
      - dev_backend

  # --- Monitor ---
  monitor_api:
    build:
      context: ./monitor/backend
    container_name: ${COMPOSE_PROJECT_NAME}_monitor_api
    ports:
      - "${MONITOR_API_PORT}:8000"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - .:/workspace:ro
    environment:
      - COMPOSE_PROJECT_NAME=${COMPOSE_PROJECT_NAME}
    networks:
      - dev_mesh

  monitor_ui:
    build:
      context: ./monitor/frontend
      args:
        - VITE_API_URL=ws://localhost:${MONITOR_API_PORT}
    container_name: ${COMPOSE_PROJECT_NAME}_monitor_ui
    ports:
      - "${MONITOR_UI_PORT}:3000"
    volumes:
      - ./monitor/frontend:/app
      - /app/node_modules
    networks:
      - dev_mesh

  # --- Agent Builder ---
  agent:
    build: 
      context: ./docker
      dockerfile: agent.Dockerfile
    container_name: ${OPENCODE_AGENT_NAME}
    working_dir: /workspace
    # Mount Docker Socket so the Agent can control the backend/frontend containers
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./:/workspace
    environment:
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - COMPOSE_PROJECT_NAME=${COMPOSE_PROJECT_NAME}
      - WORKSPACE_ROOT=${WORKSPACE_ROOT}
    networks:
      - dev_mesh
    # Keep the container running so the 'ralph_loop.sh' can execute
    command: tail -f /dev/null
    